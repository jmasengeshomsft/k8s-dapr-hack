trigger: none

resources:
  pipelines:
  - pipeline: build
    source: 'TrafficControlService - BUILD'
  
variables:
  - group: dapr-traffic-control-demo
  - name: containerImage
    value: '$(acrName).azurecr.io/dapr-hack/trafficcontrolservice:$(resources.pipeline.build.runName)'
  - name: templateFile
    value: '$(Pipeline.Workspace)/build/deploy/main.bicep'
pool:
  vmImage: 'ubuntu-latest'

steps:

- task: AzureCLI@2
  displayName: Deploy TrafficControlService
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az deployment group create --resource-group $(resourceGroupName) --template-file $(templateFile) --parameters containerImage=$(containerImage) envName=$(environment) acrName=$(acrName) acrUsername=$(acrUsername) acrPassword=$(acrPassword) > outputs.json